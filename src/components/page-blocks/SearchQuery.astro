---
interface Props {
  query: string;
  page: number;
}
const PAGINATION_SIZE = 5;
const { query, page } = Astro.props;
import CardFeed from "./CardFeed.astro";
import Pagination from "./Pagination.astro";
import { loadFromCMS } from "../../cms/loadFromCMS";
import { randomizeArray } from "../../helpers/randomizeArray";
const cmsQuery = query ? `site.search('${query}')` : "site.index.children";

const pageParams = new URLSearchParams("");
pageParams.append("query", query);
pageParams.append("page", (page + 1).toString());

const getPaginationURL = (page: number) => {
  const tempParams = new URLSearchParams("");
  tempParams.append("query", query);
  tempParams.append("page", page.toString());
  return "?" + tempParams.toString();
};

const pages = await loadFromCMS({
  query: cmsQuery,
  select: {
    id: true,
    uuid: true,
    taxonomy: { query: "page.taxonomy.toObject()" },

    // fields for pages
    title: true,
    organizationname: true,
    role: true,
    level: true,
    hero: {
      query: `page.hero.safeResize(600)`,
      select: ["url", "width", "height"],
    },
    author: {
      query: "page.author.toPage",
      select: ["displayname", "organizationname", "location"],
    },
    location: true,
    // fields for people
    displayname: true,
    photo: {
      query: `page.photo.isNotEmpty ? page.photo.toFile.crop(256,256) : null`,
    },
  },
  pagination: {
    limit: PAGINATION_SIZE,
    page: page,
  },
});
console.log(pages.pagination);
const paginationData = pages.pagination;
const sortedPages = randomizeArray(pages.data);
const startPage = (paginationData.page - 1) * PAGINATION_SIZE + 1;
const endPage = startPage + pages.data.length - 1;
---

{query ? <h2>Results for: {query}</h2> : <h2>Explore Earthrise Commons:</h2>}
<code>{JSON.stringify(paginationData, null, 2)}</code>
<p>Results {startPage} through {endPage} of {paginationData.total}</p>

<!-- <pre>{JSON.stringify(pages,null,5)}</pre> -->
<CardFeed pageData={sortedPages} />
<Pagination current={page} max={paginationData.pages} query={query} />
